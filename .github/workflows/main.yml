name: Secure Deploy to Linode

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: 3. Generate SSH Keys for Deployment
        run: ssh-keygen -t rsa -b 4096 -f ~/.ssh/deploy_key -N ""

      - name: 4. Terraform Init & Apply
        id: terraform
        env:
          TF_VAR_linode_token: ${{ secrets.LINODE_TOKEN }}
          TF_VAR_root_password: ${{ secrets.SERVER_ROOT_PASSWORD }}
          TF_VAR_authorized_keys: |
            [ 
              "${{ join(split(fromJSON(toJSON(cat('~/.ssh/deploy_key.pub'))), '\n'), '", "') }}"
            ]
        run: |
          terraform init
          terraform apply -auto-approve
          echo "instance_ip=$(terraform output -raw instance_ip)" >> $GITHUB_OUTPUT

      - name: 5. Wait for SSH to be ready
        run: |
          echo "Waiting for server to be ready..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key root@${{ steps.terraform.outputs.instance_ip }} "echo 'SSH is ready'"; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $i: SSH not ready yet, waiting 5 seconds..."
            sleep 5
          done

      - name: 6. Setup Secure Deploy User on Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key root@${{ steps.terraform.outputs.instance_ip }} << 'EOF'
            # Create a new user 'deployer'
            if ! id -u deployer >/dev/null 2>&1; then
              useradd -m -s /bin/bash deployer
              # Add user to sudo group
              usermod -aG sudo deployer
              # Add user to docker group
              usermod -aG docker deployer
              # Copy authorized_keys from root to the new user
              mkdir -p /home/deployer/.ssh
              cp /root/.ssh/authorized_keys /home/deployer/.ssh/
              chown -R deployer:deployer /home/deployer/.ssh
              # Allow sudo without password for the deployer user
              echo 'deployer ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
            fi
          EOF

      - name: 7. Create .env file from Secrets
        run: |
          echo "Creating .env file..."
          cat << EOF > .env
          POSTGRES_USER=n8nuser
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=n8n_db
          N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}
          EOF

      - name: 8. Copy Files to Server as Deploy User
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ./docker-compose.yml deployer@${{ steps.terraform.outputs.instance_ip }}:/home/deployer/
          scp -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ./.env deployer@${{ steps.terraform.outputs.instance_ip }}:/home/deployer/

      - name: 9. Install Docker and Run Services as Deploy User
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key deployer@${{ steps.terraform.outputs.instance_ip }} << 'EOF'
            # Install Docker if not present
            if ! command -v docker &> /dev/null
            then
                echo "Docker not found, installing..."
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl
                sudo install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                sudo chmod a+r /etc/apt/keyrings/docker.gpg
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            fi
            
            # Go to the project directory and start services
            cd /home/deployer
            docker compose up -d
          EOF