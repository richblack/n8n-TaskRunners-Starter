# 專案經驗教訓記錄

## n8n 版本更新問題排查 (2025-10-02)

### 問題描述
更新 n8n 從 1.106.3 到 1.113.3 後出現 404/504 錯誤，無法訪問 n8n 界面。

### 根本原因

**關鍵問題**：遠端服務器使用的是 **Traefik** 反向代理，而不是 Caddy。

#### 1. 缺少 Traefik Labels
- n8n 容器沒有配置 Traefik 路由標籤
- Traefik 無法識別和路由流量到 n8n

#### 2. 網絡連接問題
- n8n 容器只連接到 `supabase_default` 網絡
- Traefik 運行在 `supabase-n8n-minimal_default` 網絡
- 兩個網絡無法互通

#### 3. Traefik Host 規則語法錯誤
- ❌ 錯誤：`Host('n8n.uncle6.me')` (單引號)
- ✅ 正確：`Host(\`n8n.uncle6.me\`)` (反引號)
- Traefik 解析錯誤：`illegal rune literal`

#### 4. 加密金鑰問題
- n8n 數據存儲在 PostgreSQL 中，憑證需要加密金鑰解密
- 更新時必須保留原有加密金鑰：`iE1dGMZQsK8IPCt6pvIi4X+eFxhb7lbs`
- 否則會出現 "Credentials could not be decrypted" 錯誤

#### 5. Volume 配置缺失
- docker-compose.yml 沒有配置持久化 volume
- 導致每次重啟容器都會丟失配置和加密金鑰

### 正確的 n8n 配置

```yaml
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n_app
    restart: always
    volumes:
      - supabase-n8n-minimal_n8n_data:/home/node/.n8n  # 持久化配置
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: db
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: postgres
      DB_POSTGRESDB_USER: supabase_admin
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      GENERIC_TIMEZONE: Asia/Taipei
      N8N_USER_MANAGEMENT_DISABLED: false
      N8N_ENCRYPTION_KEY: iE1dGMZQsK8IPCt6pvIi4X+eFxhb7lbs  # 必須保留！
      N8N_HOST: ${N8N_HOST}
      WEBHOOK_URL: ${WEBHOOK_URL}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(\`n8n.uncle6.me\`)"  # 注意反引號
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    depends_on:
      db:
        condition: service_healthy

volumes:
  supabase-n8n-minimal_n8n_data:
    external: true  # 聲明外部 volume
```

### 快速排查步驟（下次更新使用）

1. **檢查反向代理類型**
   ```bash
   docker ps | grep -E 'traefik|caddy|nginx'
   ```

2. **檢查容器 labels**
   ```bash
   docker inspect n8n_app --format '{{json .Config.Labels}}' | python3 -m json.tool
   ```

3. **檢查網絡連接**
   ```bash
   # 查看 Traefik 網絡
   docker inspect traefik --format '{{range .NetworkSettings.Networks}}{{.NetworkID}}{{end}}'

   # 查看 n8n 網絡
   docker inspect n8n_app --format '{{range .NetworkSettings.Networks}}{{println .NetworkID}}{{end}}'
   ```

4. **檢查 Traefik 日誌**
   ```bash
   docker logs traefik --tail 50 | grep -i 'n8n\|error'
   ```

5. **驗證加密金鑰**
   ```bash
   docker run --rm -v supabase-n8n-minimal_n8n_data:/data alpine cat /data/config
   ```

### 標準更新流程

```bash
# 1. 備份（必須！）
/root/backup-n8n.sh

# 2. 拉取最新映像
cd /root
docker compose pull n8n

# 3. 重新創建容器（保留網絡和 volume）
docker compose up -d n8n

# 4. 如果網絡丟失，手動連接
docker network connect supabase-n8n-minimal_default n8n_app

# 5. 檢查服務
docker logs n8n_app --tail 50
curl -I https://n8n.uncle6.me
```

### 重要配置文件位置

- **主配置**: `/root/docker-compose.yml`
- **環境變數**: `/root/.env`
- **n8n 數據 Volume**: `supabase-n8n-minimal_n8n_data`
- **數據庫**: PostgreSQL (容器名: `supabase-db`)
- **反向代理**: Traefik (容器名: `traefik`)
- **網絡**: `supabase-n8n-minimal_default`

### 教訓總結

1. ⚠️ **更新前必須備份** - 包含數據庫和配置
2. ⚠️ **確認反向代理類型** - 不同代理配置方式不同
3. ⚠️ **保留加密金鑰** - 否則無法解密現有憑證
4. ⚠️ **檢查 Traefik 日誌** - 可快速定位路由問題
5. ⚠️ **配置持久化 volume** - 避免配置丟失
6. ⚠️ **確保網絡連接正確** - 容器必須在同一網絡才能通信

### 相關腳本

- 備份腳本: `/root/backup-n8n.sh`
- 恢復腳本: `/root/restore-n8n.sh`
- 快速參考: `/root/n8n-backup-cheatsheet.txt`
- 完整文檔: `/root/backups/README.md`

---

**更新日期**: 2025-10-02
**處理時間**: ~2 小時
**主要原因**: 缺少 Traefik 配置和網絡連接
**最終版本**: n8n 1.113.3
